
<div id="signDiv">
    玩家昵称: <input id="signDiv-username" type="text"/><br>
    <button id="signDiv-signIn">进入测试房间</button>
</div>


<div id="lobbyDiv">
    <div class="container">
        <div class="row">
            <div class="col-lg-3" id="table_seat_0">
                
            </div>
            <div class="col-lg-3" id="table_seat_1">

            </div>
            <div class="col-lg-3" id="table_seat_2">

            </div>
            <div class="col-lg-3" id="table_seat_3">

            </div>
        </div>
    </div>
</div>


<div id="gameDiv">
    <style>
    #text-overlay {
        position: absolute;
        z-index: 0;
    }

    #text-overlay * {
        position: absolute;
    }

    #text-overlay textarea {
        border: 0;
        background-color: transparent;
        height: auto;
    }

    canvas {
        position: absolute;
        z-index: -1;
    }
    </style>

    <div id="text-overlay">
    </div>

    <!-- Here goes the canvas -->

</div>



<script src="js/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>

<script>

// var socket = io();
var socket = {};
socket.on = function(a, b){}


/* Login part */

var signDiv = document.getElementById('signDiv');
var signDivUsername = document.getElementById('signDiv-username');
var signDivSignIn = document.getElementById('signDiv-signIn');

signDiv.style.display = "none";

var lobbyDiv = document.getElementById('lobbyDiv');
lobbyDiv.style.display = "none";

var gameDiv = document.getElementById('gameDiv');
// gameDiv.style.display = 'none';


socket.on('UpdateSeatInfo', function(data){
    for(let i = 0;i < 4; i++){
        if(data.names[i] == "<空闲>"){
            playerNameOnSeat[i] = "";
            document.getElementById("table_seat_"+i).innerHTML = '<button onclick="takeSeat('+i+')">选择该座位</button>';
        }
        else{
            playerNameOnSeat[i] = data.names[i];

            if(data.names[i] != myName){
                document.getElementById("table_seat_"+i).innerHTML = 
                '<span>' + data.names[i] + '</span>' + 
                '<span style="color:#353;">' + data.ready[i] + '</span>';
            }
            else{
                mySeat = i;
                if(!data.ready[i])
                    document.getElementById("table_seat_"+i).innerHTML = '<span>' + data.names[i] + '</span>' + '<button id="ready-btn" onclick="ready();">准备</button>';
                else
                    document.getElementById("table_seat_"+i).innerHTML = '<span>' + data.names[i] + '</span>' + '<span style="color:#353;">' + data.ready[i] + '</span>';                    
            }
        }
    }
});


socket.on('StartGame', function(data){
    lobbyDiv.style.display = "none";
    gameDiv.style.display = "";
});




/* Game Constants */
const GameState = {
    NotStarted : "NotStarted",
    SetNewActivePlayer : "SetNewActionPlayer",
    CallingForStoryCard : "CallingForStoryCard",
    CallingForActionCard_1 : "CallingForActionCard_1",
    CallingForActionCard_2 : "CallingForActionCard_2",
    CallingForDecision : "CallingForDecision",
    PerformAction : "PerformAction",
    GameOver : "GameOver",
};

const GameEvent = {
    // initialize
    InitCardPile : "InitCardPile",

    // gameplay
    CallingForStoryCard : "CallingForStoryCard",
    HandInStoryCard : "HandInStoryCard",
    CallingForActionCard : "CallingForActionCard",
    HandInActionCard : "HandInActionCard",
    CallingForDecision : "CallingForDecision",
    MakeDecision : "MakeDecision",

    // state synchronization
    SyncStoryCards : "SyncStoryCards",
    SyncActionCards : "SyncActionCards",
    UpdateGameInfo : "UpdateGameInfo",
    AnnounceLoser : "AnnounceLoser",
}

/* Gameplay Variables */

var myName = "";
var mySeat = -1;
var playerNameOnSeat = ["", "", "", ""];

var gameState;  // 游戏状态
var playerProperties;   // 四名玩家的数值
var myStoryCards;   // 本玩家拥有的事件卡（5张）
var myActionCards;  // 本玩家拥有的动作卡（2张）
var storyCardOnTable;   // 当前回合打出的事件卡
var storyCardOnTableOwner;  // 当前回合打出事件卡的玩家
var actionCardsOnTable;  // 当前回合打出的动作卡
var actionCardOnTableOwners = [null, null]; // 当前回合打出动作卡的玩家
var playerDecision; // 当前回合玩家做出的选择
var mySelectedStoryCardIndex; // 本玩家选择的事件卡（接下来要选择受事者了）

var textOverlayElement = document.getElementById("text-overlay");

var playerPanelSprites = [null, null, null, null];  // 玩家信息卡Sprite
var playerPropertyTextSprites = [null, null, null, null];   // 玩家数值UI的Sprites
var myStoryCardSprites = [];    // 本玩家的故事卡槽
var myStoryCardTitleElements = [];  // 本玩家的故事卡名称在text-overlay层对应的文本元素
var myStoryCardResultElements = []; // 本玩家的故事卡引起的数值变化显示在text-overlay层对应的文本元素
var myActionCardSprites = [];   // 本玩家的动作卡槽
var myActionCardTitleElements = []; // 本玩家的动作卡名称在text-overlay层对应的文本元素
var myActionCardResultElements = []; // 本玩家的动作卡将对当前回合的事件引起的数值变化在text-overlay层对应的文本元素

var storyCardOnTableSprite = null;  // 当前回合桌上的事件卡Sprite
var storyCardOnTableTitleElement = null;    // 当前回合桌上事件卡名称在text-overlay层的文本元素
var storyCardOnTableStoryElement = null;    // 当前回合桌上事件卡故事在text-overlay层的文本元素
var storyCardOnTableOwnerElement = null;    // 当前回合桌上事件卡所属玩家在text-overlay层的文本元素

var actionCardOnTableSprites = [null, null];    // 当前回合桌上的动作卡（两张）Sprite
var actionCardOnTableResultElements = [null, null]; // 当前回合桌上的动作卡造成结果在text-overlay层的文本元素
var actionCardOnTableActionElements = [null, null]; // 当前回合桌上动作卡动作名称在text-overlay层的文本元素
var actionCardOnTableOwnerElements = [null, null];   // 当前回合桌上动作卡所属玩家在text-overlay层的文本元素
var actionCardOnTableShown = [false, false];


var selectPanelBorderSprite = null; // 鼠标划过playerpanel时的显示效果
var selectActionCardBorderSprite = null;    // 鼠标划过动作卡时的显示效果
var selectStoryCardBorderSprite = null;     // 鼠标划过故事卡时的显示效果
var activePanelBorderSprite = null; // 玩家正在操作时的显示效果

var lastSelectCardSprite = null;
var lastSelectPanelSprite = null;
var lastActivePanelSprite = null;


/* Graphics */

const standardScreenWidth = 1535;
const standardScreenHeight = 758;
const standardCardWidth = 240;
const standardCardHeight = 180;
const originalCardWidth = 300;
const originalCardHeight = 200;



var textOverlay = document.createElement("div");
textOverlay.setAttribute("class", "text-overlay");


var type = "WebGL";
if(!PIXI.utils.isWebGLSupported()){
    type = "canvas";
}

var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight);
renderer.view.style.border = "1px black";
renderer.backgroundColor = 0x061639;
renderer.view.style.position = "absolute";
renderer.autoResize = true;

gameDiv.appendChild(renderer.view);

var stage = new PIXI.Container();

PIXI.loader
    .add("img/cardback.png")
    .add("img/icons.png")
    .add("img/border.png")
    .add("img/border_vertical.png")
    .add("img/storycardback.png")
    .add("img/border_active.png")
    .load(setupUI);


setupTextOverlay();


function clearStage(){
    gameDiv.style.display = "none";
    lobbyDiv.style.display = "";
}

function renderStage(){
    renderer.render(stage);
}

function updatePlayerPropertyUI(){
    for(let i = 0; i < 4; i++){
        playerPropertyTextSprites[i][0].text = playerProperties[i].army;
        playerPropertyTextSprites[i][1].text = playerProperties[i].church;
        playerPropertyTextSprites[i][2].text = playerProperties[i].eco;
        playerPropertyTextSprites[i][3].text = playerProperties[i].people;
    }
    renderStage();
}

function getColored(v){
    if(v < 0){
        return '<span style="color: #0F0;">'+ v +'</span>';
    }
    if(v > 0){
        return '<span style="color: #F00;">'+ v +'</span>';
    }
    return '<span style="color: #230;">'+ v +'</span>';
}

function updateMyStoryCardUI(){
    for(let i = 0; i < 5; i++){
        myStoryCardTitleElements[i].innerText = myStoryCards[i].name;
        let txt = "";
        let values = myStoryCard[i].result["accept"];
        txt += "同意-" + getColored(values["army"]) + " " + getColored(values["church"]) + " " + getColored(values["eco"]) + " " + getColored(values["people"]) + "<br>";
        values = myStoryCard[i].result["reject"];
        txt += "拒绝-" + getColored(values["army"]) + " " + getColored(values["church"]) + " " + getColored(values["eco"]) + " " + getColored(values["people"]) + "<br>";
        values = myStoryCard[i].result["ignore"];
        txt += "中立-" + getColored(values["army"]) + " " + getColored(values["church"]) + " " + getColored(values["eco"]) + " " + getColored(values["people"]) + "<br>";
        myStoryCardResultElements[i].innerHTML = txt;
    }
}


function updateMyActionCardUI(){
    for(let i = 0; i < 2; i++){
        myActionCardTitleElements[i].innerText = myActionCards[i].name;
        if(storyCardOnTable == null)
            myActionCardResultElements[i].innerHTML = "";
        else{
            let values = storyCardOnTable.result[myActionCard[i].action];
            myActionCardResultElements[i].innerHTML = getColored(values["army"]) + " " + getColored(values["church"]) + " " + getColored(values["eco"]) + " " + getColored(values["people"]);
        }
    }
}


function showStoryCardOnTable(){
    stage.addChild(storyCardOnTableSprite);
    storyCardOnTableTitleElement.innerText = storyCardOnTable.name;
    storyCardOnTableTitleElement.style.display = "";
    storyCardOnTableStoryElement.innerText = storyCardOnTable.story;
    storyCardOnTableStoryElement.style.display = "";
    storyCardOnTableOwnerElement.innerText = "from " + playerNameOnSeat[storyCardOnTableOwner];
    storyCardOnTableOwnerElement.style.display = "";
    renderStage();
}


function hideStoryCardOnTable(){
    stage.removeChild(storyCardOnTableSprite);
    storyCardOnTableTitleElement.style.display = "none";
    storyCardOnTableStoryElement.style.display = "none";
    storyCardOnTableOwnerElement.style.display = "none";
    renderStage();
}


function showActionCardOnTable(){
    for(let i = 0; i < 2; i++){
        if(actionCardsOnTable[i] == null) continue;
        if(actionCardOnTableShown[i]) continue;

        stage.addChild(actionCardOnTableSprites[i]);
        actionCardOnTableActionElements[i].innerText = actionCardsOnTable[i].name;
        let values = storyCardOnTable.result[actionCardsOnTable[i].action];
        actionCardOnTableResultElements[i].innerHTML = 
            getColored(values["army"]) + " " + getColored(values["church"]) + " " + getColored(values["eco"]) + " " + getColored(values["people"]);
        actionCardOnTableResultElements[i].style.display = "";

        actionCardOnTableOwnerElements[i].innerText = playerNameOnSeat[actionCardOnTableOwners[i]];
        actionCardOnTableOwnerElements[i].style.display = "";

        actionCardOnTableShown[i] = true;
    }
    renderStage();
}

function hideActionCardsOnTable(){
    for(let i = 0; i < 2; i++){
        stage.removeChild(actionCardOnTableSprites[i]);
        actionCardOnTableActionElements[i].style.display = "none";
        actionCardOnTableResultElements[i].style.display = "none";
        actionCardOnTableOwnerElements[i].style.display = "none";
        actionCardOnTableShown[i] = false;
    }
    renderStage();
}



function setupUI(){

    /* 4 player panels */

    var cardsizex = window.innerWidth / standardScreenWidth * standardCardWidth;
    var cardsizey = cardsizex * standardCardHeight / standardCardWidth;
    var bordersizex = 0.025 * 2.5 * window.innerWidth, bordersizey = 0.05 * 0.5 * window.innerHeight;
    var panel_pos_x = [(renderer.width - cardsizex)/2, bordersizex, (renderer.width - cardsizex)/2, renderer.width - bordersizex - cardsizex];
    var panel_pos_y = [renderer.height - bordersizey - cardsizey, (renderer.height - cardsizey)/2, bordersizey, (renderer.height - cardsizey)/2];

    for(let i = 0; i < 4; i++){
        let index = (i + 4 - mySeat) % 4;
        playerPanelSprites[index] = new PIXI.Sprite(
            PIXI.loader.resources["img/cardback.png"].texture
        );

        playerPanelSprites[index].width = cardsizex;
        playerPanelSprites[index].height = cardsizey;
        playerPanelSprites[index].x = panel_pos_x[i];
        playerPanelSprites[index].y = panel_pos_y[i];
        playerPanelSprites[index].interactive = true;
        playerPanelSprites[index].index = index;

        let icon_sprite = new PIXI.Sprite(PIXI.loader.resources["img/icons.png"].texture);
        playerPanelSprites[index].addChild(icon_sprite);


        playerPropertyTextSprites[index] = [];
        for(let j = 0; j < 4; j++){
            var t = new PIXI.Text(
                10,
                {font: '15px Arial', fill: 0x000000}
            );
            playerPropertyTextSprites[index].push(t);
            playerPropertyTextSprites[index][j].x = 95 + j * 56;
            playerPropertyTextSprites[index][j].y = 116;
            playerPanelSprites[index].addChild(playerPropertyTextSprites[index][j]);
        }

        let label = new PIXI.Text(index,
            {font: '15px Arial', fill: 0xFFFFFF});
        
        playerPanelSprites[index].addChild(label);

        stage.addChild(playerPanelSprites[index]);
    }

    /* 5 story card slots */
    var storycardsizex = standardCardHeight * standardScreenWidth / standardScreenWidth; // correct!
    var storycardsizey = storycardsizex * standardCardWidth / standardCardHeight;                 // correct!

    for(let i = 0; i < 5; i++){
        myStoryCardSprites[i] = new PIXI.Sprite(
            PIXI.loader.resources["img/storycardback.png"].texture
        );

        myStoryCardSprites[i].width = 2 * 0.025 * window.innerWidth;
        myStoryCardSprites[i].height = 3 * 0.05 * window.innerHeight;
        myStoryCardSprites[i].x = (24 + i*2) * 0.025 * window.innerWidth;
        myStoryCardSprites[i].y = 16 * 0.05 * window.innerHeight;
        myStoryCardSprites[i].index = i;

        stage.addChild(myStoryCardSprites[i]);
    }

    /* 2 action card slots */
    for(let i = 0; i < 2; i++){
        myActionCardSprites[i] = new PIXI.Sprite(
            PIXI.loader.resources["img/storycardback.png"].texture
        );

        myActionCardSprites[i].width = 2 * 0.025 * window.innerWidth;
        myActionCardSprites[i].height = 3 * 0.05 * window.innerHeight;
        myActionCardSprites[i].x = (12 + i * 2) * 0.025 * window.innerWidth;
        myActionCardSprites[i].y = 16 * 0.05 * window.innerHeight;
        myActionCardSprites[i].index = i;

        stage.addChild(myActionCardSprites[i]);
    }

    storyCardOnTableSprite = new PIXI.Sprite(PIXI.loader.resources["img/storycardback.png"].texture);
    storyCardOnTableSprite.width = 5 * 0.025 * window.innerWidth;
    storyCardOnTableSprite.height = 8 * 0.05 * window.innerHeight;
    storyCardOnTableSprite.x = 17.5 * 0.025 * window.innerWidth;
    storyCardOnTableSprite.y = 6 * 0.05 * window.innerHeight;

    // debug
    stage.addChild(storyCardOnTableSprite);

    for(let i = 0; i < 2; i++){
        actionCardOnTableSprites[i] = new PIXI.Sprite(
            PIXI.loader.resources["img/storycardback.png"].texture
        );

        actionCardOnTableSprites[i].width = 4 * 0.025 * window.innerWidth;
        actionCardOnTableSprites[i].height = 6 * 0.05 * window.innerHeight;
        actionCardOnTableSprites[i].x = (11 + i*14) * 0.025 * window.innerWidth;
        actionCardOnTableSprites[i].y = 7.5 * 0.05 * window.innerHeight;

        // debug
        stage.addChild(actionCardOnTableSprites[i]);
    }


    selectStoryCardBorderSprite = new PIXI.Sprite(PIXI.loader.resources["img/border_vertical.png"].texture);
    selectPanelBorderSprite = new PIXI.Sprite(PIXI.loader.resources["img/border.png"].texture);
    activePanelBorderSprite = new PIXI.Sprite(PIXI.loader.resources["img/border_active.png"].texture);

    renderStage();
}


function setupTextOverlay() {
    myStoryCardTitleElements = [];
    myStoryCardResultElements = [];
    for(let i = 0; i < 5; i++){
        let title_elm = document.createElement("div");
        title_elm.id = "myStoryCardTitleElement-"+i;
        myStoryCardTitleElements.push(title_elm);

        let result_elm = document.createElement("div");
        result_elm.id = "myStoryCardResultElement-"+i;
        myStoryCardResultElements.push(result_elm);
    }

    myActionCardTitleElements = [];
    myActionCardResultElements = [];
    for(let i = 0; i < 2; i++){
        let title_elm = document.createElement("div");
        title_elm.id = "myActionCardTitleElement-"+i;
        myActionCardTitleElements.push(title_elm);

        let result_elm = document.createElement("div");
        result_elm.id = "myActionCardResultElement-"+i;
        myActionCardResultElements.push(result_elm);
    }

    storyCardOnTableTitleElement = document.createElement("div");
    storyCardOnTableTitleElement.id = "storyCardOnTableTitleElement";
    storyCardOnTableStoryElement = document.createElement("textarea");
    storyCardOnTableStoryElement.id = "storyCardOnTableStoryElement";
    storyCardOnTableOwnerElement = document.createElement("div");
    storyCardOnTableOwnerElement.id = "storyCardOnTableOwnerElement";
    
    for(let i = 0; i < 2; i++){
        actionCardOnTableActionElements[i] = document.createElement("div");
        actionCardOnTableActionElements[i].id = "actionCardOnTableActionElement-"+i;
        actionCardOnTableResultElements[i] = document.createElement("div");
        actionCardOnTableResultElements[i].id = "actionCardOnTableResultElement-"+i;
        actionCardOnTableOwnerElements[i] = document.createElement("div");
        actionCardOnTableOwnerElements[i].id = "actionCardOnTableOwnerElement-"+i;
    }

}

function setElementPosition(element, left, top){
    element.style.left = left;
    element.style.top = top;
}

function adjustTextOverlayPositioning(){
    // left action card on table
    setElementPosition(
        actionCardOnTableActionElements[0],
        12 * 0.025 * window.innerWidth,
         8 * 0.05 * window.innerHeight,
    );

    setElementPosition(
        actionCardOnTableResultElements[0],
        11.5 * 0.025 * window.innerWidth,
        10 * 0.05 * window.innerHeight,
    );

    setElementPosition(
        actionCardOnTableOwnerElements[0],
        12 * 0.025 * window.innerWidth,
        12 * 0.05 * window.innerHeight
    );


    // story card on table
    setElementPosition(
        storyCardOnTableTitleElement,
        18 * 0.025 * window.innerWidth,
        6.5 * 0.05 * window.innerHeight
    );

    setElementPosition(
        storyCardOnTableStoryElement,
        18 * 0.025 * window.innerWidth,
        8 * 0.05 * window.innerHeight
    );

    setElementPosition(
        storyCardOnTableOwnerElement,
        18 * 0.025 * window.innerWidth,
        12 * 0.05 * window.innerHeight
    );

    // right action card on table
    setElementPosition(
        actionCardOnTableActionElements[1],
        26 * 0.025 * window.innerWidth,
         8 * 0.05 * window.innerHeight,
    );

    setElementPosition(
        actionCardOnTableResultElements[1],
        25.5 * 0.025 * window.innerWidth,
        10 * 0.05 * window.innerHeight,
    );

    setElementPosition(
        actionCardOnTableOwnerElements[1],
        26 * 0.025 * window.innerWidth,
        12 * 0.05 * window.innerHeight
    );

    // my action cards
    for(let i = 0; i < 2; i++){
        setElementPosition(
            myActionCardTitleElements[i],
            (12 + i*2) * 0.25 * window.innerWidth,
            16.5 * 0.05 * window.innerHeight,
        );

        setElementPosition(
            myActionCardResultElements[i],
            (12 + i*2) * 0.25 * window.innerWidth,
            17.5 * 0.05 * window.innerHeight
        );
    }

    // my story cards
    for(let i = 0; i < 5; i++){
        setElementPosition(
            myStoryCardTitleElements[i],
            (24 + i * 2) * 0.25 * window.innerWidth,
            16.5 * 0.05 * window.innerHeight
        );

        setElementPosition(
            myStoryCardResultElements[i],
            (24 + i * 2) * 0.25 + window.innerWidth,
            17.5 * 0.05 * window.innerHeight
        );
    }
}


/* Event Handlers */

socket.on(GameEvent.InitCardPile, function(data){
    myStoryCards = data.storyCards;
    myActionCards = data.actionCards;
    renderStage();
});


var handInStoryCard = function(index, target){
    socket.emit(GameEvent.HandInStoryCard, {cardIndex : index, target : target});
}


socket.on(GameEvent.CallingForStoryCard, function(){
    for(i in myStoryCardSprites){
        myStoryCardSprites[i].interactive = true;
        myStoryCardSprites[i].mouseover = function(e){
            e.currentTarget.addChild(selectStoryCardBorderSprite);
            lastSelectCardSprite = e.currentTarget;
            e.stopPropagation();
            renderStage();
        }
        myStoryCardSprites[i].mouseout = function(e){
            e.currentTarget.removeChild(selecetStoryCardBorderSprite);
            lastSelectCardSprite = null;
            e.stopPropagation();
            renderStage();
        }
        myStoryCardSprites[i].click = function(e){
            mySelectedStoryCardIndex = e.currentTarget.index;
            for(j in playerPanelSprites){
                playerPanelSprites[j].interactive = true;
                playerPanelSprites[j].mouseover = function(e){
                    e.currentTarget.addChild(selectPanelBorderSprite);
                    lastSelectPanelSprite = e.currentTarget;
                    e.stopPropagation();
                    renderStage();
                }
                playerPanelSprites[j].mouseout = function(e){
                    e.currentTarget.removeChild(selectPanelBorderSprite);
                    lastSelectCardSprite = null;
                    e.stopPropagation();
                    renderStage();
                }
                playerPanelSprites[j].click = function(e){
                    handInStoryCard(mySelectedStoryCardIndex, e.currentTarget.index);

                    if(lastSelectCardSprite != null) lastSelectCardSprite.removeChild(selectStoryCardBorderSprite);
                    if(lastSelectPanelSprite != null) lastSelectPanelSprite.removeChild(selectPanelBorderSprite);

                    for(k in myStoryCardSprites){
                        myStoryCardSprites[k].interactive = false;
                        myStoryCardSprites[k].mouseover = function(e){};
                        myStoryCardSprites[k].mouseout = function(e){};
                        myStoryCardSprites[k].click = function(e){}
                    }
                    for(k in playerPanelSprites){
                        playerPanelSprites[k].interactive = false;
                        playerPanelSprites[k].mouseover = function(e){};
                        playerPanelSprites[k].mouseout = function(e){};
                        playerPanelSprites[k].click = function(e){}
                    }

                    renderStage();
                }
            }
        }
    }
});


var handInActionCard = function(index){
    socket.emit(GameEvent.HandInActionCard, {cardIndex : index});  
};


socket.on(GameEvent.CallingForActionCard, function(){
    for(i in myActionCardSprites){
        myActionCardSprites[i].interactive = true;
        myActionCardSprites[i].mouseover = function(e){
            e.currentTarget.addChild(selectStoryCardBorderSprite);
            lastSelectCardSprite = e.currentTarget;
            e.stopPropagation();
            renderStage();
        }
        myActionCardSprites[i].mouseout = function(e){
            e.currentTarget.removeChild(selectStoryCardBorderSprite);
            lastSelectCardSprite = null;
            e.stopPropagation();
            renderStage();
        }
        myActionCardSprites[i].click = function(e){
            handInActionCard(e.currentTarget.index);
            for(j in myActionCardSprites){
                myActionCardSprites[j].interactive = false;
                myActionCardSprites[j].mouseout = function(e){}
                myActionCardSprites[j].mouseover = function(e){}
                myActionCardSprites[j].click = function(e){}
            }
            if(lastSelectCardSprite != null){
                lastSelectCardSprite.removeChild(selectStoryCardBorderSprite);
            }
        }
    }
});


var makeDecision = function(index){
    socket.emit(GameEvent.MakeDecision, {decision : index});
}


socket.on(GameEvent.CallingForDecision, function(){
    for(i in actionCardOnTableSprites){
        actionCardOnTableSprites[i].interactive = true;
        actionCardOnTableSprites[i].mouseover = function(e){
            e.currentTarget.addChild(selectStoryCardBorderSprite);
            lastSelectCardSprite = e.currentTarget;
            e.stopPropagation();
            renderStage();
        }
        actionCardOnTableSprites[i].mouseout = function(e){
            e.currentTarget.removeChild(selectStoryCardBorderSprite);
            lastSelectCardSprite = null;
            e.stopPropagation();
            renderStage();
        }
        actionCardOnTableSprites[i].click = function(e){
            makeDecision(actionCardOnTableSprites[i].index);
            for(j in actionCardOnTableSprites){
                actionCardOnTableSprites[j].interactive = false;
                actionCardOnTableSprites[j].mouseover = function(e){}
                actionCardOnTableSprites[j].mouseout = function(e){}
                actionCardOnTableSprites[j].click = function(e){}
            }
            if(lastSelectCardSprite != null)
                lastSelectCardSprite.removeChild(selectStoryCardBorderSprite);
        }
    }
})

socket.on(GameEvent.SyncActionCards, function(data){
    myActionCards = data;
    updateMyActionCardUI();
})

socket.on(GameEvent.SyncStoryCards, function(data){
    myStoryCards = data;
    updateMyStoryCardUI();
})

socket.on(GameEvent.UpdateGameInfo, function(data){
    gameState = data.state;
    playerProperties = data.properties;

    switch(data.state){
        case GameState.CallingForStoryCard:
        {
            if(lastActivePanelSprite != null)
                lastActivePanelSprite.removeChild(activePanelBorderSprite);
            playerPanelSprites[data.whosactive].addChild(activePanelBorderSprite);
            lastActivePanelSprite = playerPanelSprites[data.whosactive];
            
            for(let i = 0; i < 2; i++){
                if(actionCardOnTableShown[i]){
                    actionCardOnTableActionElements[i].style.display = "none";
                    actionCardOnTableResultElements[i].style.display = "none";
                    actionCardOnTableOwnerElements[i].style.display = "none";
                    stage.removeChild(actionCardOnTableSprites[i]);
                }
            }


            if(storyCardOnTable != null){
                storyCardOnTableStoryElement.style.display = "none";
                storyCardOnTableTitleElement.style.display = "none";
                storyCardOnTableOwnerElement.style.display = "none";
                stage.removeChild(storyCardOnTableSprite);
            }

            renderStage();

            storyCardOnTableOwner = data.whosactive;
        }
        break;

        case GameState.CallingForActionCard_1:
        {
            if(lastActivePanelSprite != null)
                lastActivePanelSprite.removeChild(activePanelBorderSprite);
            playerPanelSprites[data.whosactive].addChild(activePanelBorderSprite);
            lastActivePanelSprite = playerPanelSprites[data.whosactive];

            showStoryCardOnTable();
            updateMyActionCardUI(); // 显示手上的动作卡对当前事件的影响，方便玩家决策

            actionCardOnTableOwners[0] = data.whosactive;
        }
        break;

        case GameState.CallingForActionCard_2:
        {
            if(lastActivePanelSprite != null)
                lastActivePanelSprite.removeChild(activePanelBorderSprite);
            playerPanelSprites[data.whosactive].addChild(activePanelBorderSprite);
            lastActivePanelSprite = data.whosactive;

            showActionCardOnTable();

            actionCardOnTableOwners[1] = data.whosactive;
        }
        break;

        case GameState.CallingForDecision:
        {
            if(lastActivePanelSprite != null)
                lastActivePanelSprite.removeChild(activePanelBorderSprite);
            playerPanelSprites[data.whosactive].addChild(activePanelBorderSprite);
            lastActivePanelSprite = data.whosactive;

            showActionCardOnTable();
        }
        break;

    }
});


socket.on(GameEvent.AnnounceLoser, function(data){
    alert(data);
});



</script>